import network
import socket
import time
import json
from machine import ADC
import urequests  # For HTTP requests

# ===== WIFI SETTINGS =====
SSID = "SSID"
PASSWORD = "Password"

# ===== SERVER SETTINGS (your computer IP) =====
SERVER_IP = "192.168.0.x" #192.168.1.x
SERVER_PORT = 5000  # Changed to match Flask server port

# ===== ADC SETUP =====
adc = ADC(26)  # GPIO26 = ADC0 on Pico

def connect_wifi():
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)
    wlan.connect(SSID, PASSWORD)

    print("Connecting to WiFi...")
    while not wlan.isconnected():
        time.sleep(0.5)

    print("Connected! IP:", wlan.ifconfig()[0])

def read_voltage():
    raw = adc.read_u16()
    voltage = raw * 3.3 / 65535
    return voltage

def send_data(voltage):
    data = {
        "voltage": voltage,
        "timestamp": time.time()
    }

    try:
        # Using HTTP POST instead of raw socket
        url = f"http://{SERVER_IP}:{SERVER_PORT}/api/data"
        response = urequests.post(url, json=data)
        print("Sent:", data, "Response:", response.status_code)
        response.close()
    except Exception as e:
        print("Send error:", e)

# ===== MAIN LOOP =====
connect_wifi()

while True:
    v = read_voltage()
    send_data(v)
    time.sleep(1)
